<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∫–Ω–∏–≥–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/suneditor/dist/css/suneditor.min.css">
  <style>
    body{max-width:900px;margin:2rem auto;font-family:system-ui,Arial,sans-serif}
    header{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .actions{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .muted{opacity:.75;font-size:.9rem}
    .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none;cursor:pointer}
    .btn-primary{background:#111;color:#fff;border-color:#111}
    .btn-ghost{background:#fff;color:#111}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;max-width:560px;width:calc(100% - 2rem);border-radius:.75rem;padding:1.25rem;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal h2{margin:.25rem 0 .25rem 0}
    .modal p{margin:.5rem 0 1rem 0}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
    .row a,.row button{flex:1}
    .donate-options{display:grid;grid-template-columns:1fr;gap:.5rem;margin:.5rem 0 1rem}
    .donate-box{border:1px solid #eee;border-radius:.5rem;padding:.75rem}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–Ω–∏–≥–∏</h1>
      <div class="muted">Project ID: <span id="pid"></span></div>
      <p class="muted">–¢–µ—Å—Ç Cloudflare PDF: <a href="/test/pdf" target="_blank">/test/pdf</a></p>
    </div>
    <div class="actions">
      <button id="saveDraft" class="btn btn-ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>

      <!-- –ö–Ω–æ–ø–∫–∞: –æ—Ç–∫—Ä—ã—Ç—å –¢–û–õ–¨–ö–û –º–æ–¥–∞–ª–∫—É –¥–æ–Ω–∞—Ç–∞ -->
      <a id="openDonate" class="btn" href="#">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</a>

      <!-- Peecho Async (–±—É–º–∞–∂–Ω–∞—è –ø–µ—á–∞—Ç—å) ‚Äî –æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ -->
      <a id="peechoBtn" class="peecho-print-button btn btn-primary"
         href="https://www.peecho.com/"
         title="–ü–µ—á–∞—Ç—å –∫–Ω–∏–≥–∏"
         data-filetype="pdf" data-width="210" data-height="297" data-pages="100"
         data-noprice="true" data-currency="EUR" data-locale="ru_RU"
         data-thumbnail="https://placehold.co/300x400?text=Book"
         data-reference="">
         –û–ø–ª–∞—Ç–∏—Ç—å –ø–µ—á–∞—Ç—å (–±—É–º–∞–∂–Ω–∞—è)
      </a>
    </div>
  </header>

  <div class="muted" style="margin:.5rem 0 1rem">
    –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∏ <b>–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏</b> (Ctrl/Cmd+C) –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–µ <b>–ø–µ—á–∞—Ç–∏</b> (Ctrl/Cmd+P) –º—ã –ø–æ–∫–∞–∂–µ–º –æ–∫–Ω–æ ¬´–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç¬ª. –≠—Ç–æ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ.
  </div>

  <div id="editor" style="margin-top:1rem;"></div>

  <!-- SunEditor -->
  <script src="https://unpkg.com/suneditor/dist/suneditor.min.js"></script>
  <script src="https://unpkg.com/suneditor/src/lang/ru.js"></script>

  <!-- üëá –í–°–¢–ê–í–¨ –°–í–û–ô –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç Peecho (merchant button script) -->
  <script>
    (function(){
      var s=document.createElement("script"); s.async=true;
      // –ó–ê–ú–ï–ù–ò –Ω–∞ —Å–≤–æ–π URL –∏–∑ Peecho (–ø—Ä–∏–º–µ—Ä –Ω–∏–∂–µ ‚Äî –∑–∞–≥–ª—É—à–∫–∞)
      s.src="https://d3aln0nj58oevo.cloudfront.net/button/script/175871453943565676.js";
      document.head.appendChild(s);
    })();
  </script>

  <!-- DONATION MODAL (—Ç–æ–ª—å–∫–æ –¥–æ–Ω–∞—Ç) -->
  <div id="donateModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç üôè</h2>
      <p>–ï—Å–ª–∏ –≤–∞–º –ø–æ–ª–µ–∑–µ–Ω —ç—Ç–æ—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ –ø–µ—á–∞—Ç—å –∫–Ω–∏–≥ ‚Äî –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–Ω–∞—Ç. –ï—Å–ª–∏ –Ω–µ —Å–µ–π—á–∞—Å ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª.</p>

      <div class="donate-options">
        <!-- –í–∞—Ä–∏–∞–Ω—Ç 1: –ø—Ä–æ—Å—Ç—ã–µ —Å—Å—ã–ª–∫–∏ (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) -->
        <div class="donate-box">
          <strong>–ë—ã—Å—Ç—Ä—ã–µ —Å–ø–æ—Å–æ–±—ã</strong>
          <div class="row" style="margin-top:.5rem">
            <a id="donateLink1" class="btn" target="_blank" rel="noopener">PayPal.Me</a>
            <a id="donateLink2" class="btn" target="_blank" rel="noopener">Ko-fi</a>
          </div>
        </div>

        <!-- –í–∞—Ä–∏–∞–Ω—Ç 2: –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ PayPal (–ø–æ –∂–µ–ª–∞–Ω–∏—é) -->
        <div id="paypalBox" class="donate-box hidden">
          <strong>–û–ø–ª–∞—Ç–∞ –ø—Ä—è–º–æ –∑–¥–µ—Å—å (PayPal)</strong>
          <div id="paypal-button-container" style="margin-top:.5rem"></div>
        </div>
      </div>

      <div class="row">
        <button id="donateClose" class="btn btn-ghost" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò –î–û–ù–ê–¢–ê =====
    // 1) –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–∏ —Å—Å—ã–ª–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–µ).
    const DONATE_PAYPAL_ME = "https://paypal.me/yourname";   // üëà –ó–ê–ú–ï–ù–ò –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º ""
    const DONATE_KOFI      = "https://ko-fi.com/yourname";    // üëà –ó–ê–ú–ï–ù–ò –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º ""

    // 2) (–æ–ø—Ü.) –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ PayPal Smart Buttons ‚Äî –∑–∞–ø–æ–ª–Ω–∏ CLIENT ID
    const PAYPAL_CLIENT_ID = "AQ7eziOmsfbsBKBLunUh_nPcoFn5Y2NsJGsR4xY50g-NvstA4_B7P46IJTItbb9TvFkxxOagFgFG-HXB"; // üëà –µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—à—å –ø—É—Å—Ç—ã–º ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–µ –ø–æ–∫–∞–∂–µ—Ç—Å—è

    // ===== –†–ï–î–ê–ö–¢–û–† =====
    const editor = SUNEDITOR.create('editor', {
      lang: SUNEDITOR_LANG['ru'],
      height: '70vh',
      buttonList: [
        ['undo','redo','formatBlock','bold','italic','underline','removeFormat'],
        ['fontColor','hiliteColor','align','list','link','image']
      ]
    });

    // Project ID –¥–ª—è Peecho reference –∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) —Å–≤—è–∑–µ–π
    const key = 'book_project_id';
    let projectId = localStorage.getItem(key);
    if (!projectId) {
      projectId = 'PROJECT_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem(key, projectId);
    }
    document.getElementById('pid').textContent = projectId;
    document.getElementById('peechoBtn').setAttribute('data-reference', projectId);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ (–Ω–∞ –±—É–¥—É—â–µ–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    document.getElementById('saveDraft').onclick = async () => {
      const html = editor.getContents();
      const res = await fetch('/api/draft', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ merchantReference: projectId, html })
      });
      alert(res.ok ? '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    };

    // ===== –ú–û–î–ê–õ–ö–ê –î–û–ù–ê–¢–ê (—Ç–æ–ª—å–∫–æ –¥–æ–Ω–∞—Ç) =====
    const modal = document.getElementById('donateModal');
    const btnOpen = document.getElementById('openDonate');
    const btnClose = document.getElementById('donateClose');
    const link1 = document.getElementById('donateLink1');
    const link2 = document.getElementById('donateLink2');
    const paypalBox = document.getElementById('paypalBox');

    // –ü–æ–¥—Å—Ç–∞–≤–∏–º —Å—Å—ã–ª–∫–∏ (—Å–∫—Ä–æ–µ–º, –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ)
    if (DONATE_PAYPAL_ME) { link1.href = DONATE_PAYPAL_ME; } else { link1.parentElement.removeChild(link1); }
    if (DONATE_KOFI)      { link2.href = DONATE_KOFI; } else { link2.parentElement.removeChild(link2); }

    function openDonateModal() {
      modal.style.display = 'flex';
      // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º PayPal SDK –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω CLIENT_ID
      if (PAYPAL_CLIENT_ID && paypalBox.classList.contains('hidden')) {
        paypalBox.classList.remove('hidden');
        const s = document.createElement('script');
        s.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(PAYPAL_CLIENT_ID)}&currency=EUR&intent=capture`;
        s.onload = () => {
          if (window.paypal && document.getElementById('paypal-button-container')) {
            paypal.Buttons({
              style: { layout: 'horizontal', label: 'donate' },
              createOrder: (data, actions) => {
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –¥–æ–Ω–∞—Ç ‚Äî 2 EUR (–∏–∑–º–µ–Ω–∏—à—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏)
                return actions.order.create({
                  purchase_units: [{ amount: { value: '2.00', currency_code: 'EUR' } }]
                });
              },
              onApprove: (data, actions) => actions.order.capture().then(() => {
                btnClose.textContent = '–°–ø–∞—Å–∏–±–æ! –ó–∞–∫—Ä—ã—Ç—å';
              })
            }).render('#paypal-button-container');
          }
        };
        document.body.appendChild(s);
      }
    }
    function closeDonateModal(){ modal.style.display = 'none'; }

    btnOpen.addEventListener('click', e => { e.preventDefault(); openDonateModal(); });
    btnClose.addEventListener('click', () => closeDonateModal());

    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏/–ø–æ–ø—ã—Ç–∫–µ –ø–µ—á–∞—Ç–∏ ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º (–Ω–∏—á–µ–≥–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ)
    document.addEventListener('copy', () => { if (modal.style.display !== 'flex') openDonateModal(); });
    document.addEventListener('keydown', (e) => {
      const isPrint = (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p';
      if (isPrint) {
        e.preventDefault(); // –Ω–µ –ø–µ—á–∞—Ç–∞–µ–º ¬´—Å—ã—Ä–æ–π¬ª —Ä–µ–¥–∞–∫—Ç–æ—Ä
        openDonateModal();  // –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å; –¥–∞–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç—å –∏ —Ä–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å PDF, –µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑—É–µ—à—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
      }
    });
  </script>
</body>
</html>
