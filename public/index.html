<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ê–≤—Ç–æ–±–∏–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∫–Ω–∏–≥–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/suneditor/dist/css/suneditor.min.css">
  <style>
    body{max-width:900px;margin:2rem auto;font-family:system-ui,Arial,sans-serif}
    header{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .actions{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .muted{opacity:.75;font-size:.9rem}
    .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none;cursor:pointer}
    .btn-primary{background:#111;color:#fff;border-color:#111}
    .btn-ghost{background:#fff;color:#111}
    .hidden{display:none}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;max-width:560px;width:calc(100% - 2rem);border-radius:.75rem;padding:1.25rem;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal h2{margin:.25rem 0 .25rem 0}
    .modal p{margin:.5rem 0 1rem 0}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end}
    .row a,.row button{flex:1}
    .donate-options{display:grid;grid-template-columns:1fr;gap:.5rem;margin:.5rem 0 1rem}
    .donate-box{border:1px solid #eee;border-radius:.5rem;padding:.75rem}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–Ω–∏–≥–∏</h1>
      <div class="muted">Project ID: <span id="pid"></span></div>
      <p class="muted">–¢–µ—Å—Ç Cloudflare PDF: <a href="/test/pdf" target="_blank">/test/pdf</a></p>
    </div>
    <div class="actions">
      <button id="saveDraft" class="btn btn-ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>

      <!-- –æ—Ç–∫—Ä—ã—Ç—å –¢–û–õ–¨–ö–û –º–æ–¥–∞–ª–∫—É –¥–æ–Ω–∞—Ç–∞ -->
      <a id="openDonate" class="btn" href="#">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</a>

      <!-- Peecho Async (–±—É–º–∞–∂–Ω–∞—è –ø–µ—á–∞—Ç—å) ‚Äî –ë–ï–ó data-src -->
      <a id="peechoBtn" class="peecho-print-button btn btn-primary"
         href="https://www.peecho.com/"
         title="–ü–µ—á–∞—Ç—å –∫–Ω–∏–≥–∏"
         data-filetype="pdf" data-width="210" data-height="297" data-pages="100"
         data-noprice="true" data-currency="EUR" data-locale="ru_RU"
         data-thumbnail="https://placehold.co/300x400?text=Book"
         data-reference="">
         –û–ø–ª–∞—Ç–∏—Ç—å –ø–µ—á–∞—Ç—å (–±—É–º–∞–∂–Ω–∞—è)
      </a>
    </div>
  </header>

  <div class="muted" style="margin:.5rem 0 1rem">
    –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ø—Ä–∏ <b>–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏</b> (Ctrl/Cmd+C) –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–µ <b>–ø–µ—á–∞—Ç–∏</b> (Ctrl/Cmd+P) –ø–æ–∫–∞–∂–µ–º –æ–∫–Ω–æ ¬´–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç¬ª. –≠—Ç–æ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ.
  </div>

  <div id="editor" style="margin-top:1rem;"></div>

  <!-- SunEditor -->
  <script src="https://unpkg.com/suneditor/dist/suneditor.min.js"></script>
  <script src="https://unpkg.com/suneditor/src/lang/ru.js"></script>

  <!-- Peecho merchant script (–º–æ–∂–µ—à—å –æ—Å—Ç–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π –∏–∑ –∫–∞–±–∏–Ω–µ—Ç–∞) -->
  <script>
    (function(){
      var s=document.createElement("script"); s.async=true;
      s.src="https://d3aln0nj58oevo.cloudfront.net/button/script/175871453943565676.js";
      document.head.appendChild(s);
    })();
  </script>

  <!-- DONATION MODAL -->
  <div id="donateModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç üôè</h2>
      <p>–ï—Å–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–ª–µ–∑–µ–Ω ‚Äî –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–Ω–∞—Ç. –ï—Å–ª–∏ –Ω–µ —Å–µ–π—á–∞—Å ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–∫—Ä—ã—Ç—å¬ª.</p>

      <div class="donate-options">
        <!-- –í–∞—Ä–∏–∞–Ω—Ç 1: –±—ã—Å—Ç—Ä—ã–µ —Å—Å—ã–ª–∫–∏ -->
        <div class="donate-box">
          <strong>–ë—ã—Å—Ç—Ä—ã–µ —Å–ø–æ—Å–æ–±—ã</strong>
          <div class="row" style="margin-top:.5rem">
            <a id="donateLink1" class="btn hidden" target="_blank" rel="noopener">PayPal.Me</a>
            <a id="donateLink2" class="btn hidden" target="_blank" rel="noopener">Ko-fi</a>
          </div>
        </div>

        <!-- –í–∞—Ä–∏–∞–Ω—Ç 2: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ PayPal Smart Buttons -->
        <div id="paypalBox" class="donate-box hidden">
          <strong>–û–ø–ª–∞—Ç–∞ –ø—Ä—è–º–æ –∑–¥–µ—Å—å (PayPal / Card)</strong>
          <div id="paypal-button-container" style="margin-top:.5rem"></div>
        </div>
      </div>

      <div class="row">
        <button id="donateClose" class="btn btn-ghost" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // ===== –ù–ê–°–¢–†–û–ô–ö–ò (–∑–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ —ç—Ç–æ) =====
    const DONATE_PAYPAL_ME = "";             // –Ω–∞–ø—Ä. "https://paypal.me/yourname" –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º
    const DONATE_KOFI      = "";             // –Ω–∞–ø—Ä. "https://ko-fi.com/yourname" –∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º
    const PAYPAL_CLIENT_ID = "AQ7eziOmsfbsBKBLunUh_nPcoFn5Y2NsJGsR4xY50g-NvstA4_B7P46IJTItbb9TvFkxxOagFgFG-HXB";             // LIVE client-id PayPal; –µ—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã—Ç—ã
    const DONATE_AMOUNT_EUR = "2.00";        // —Å—É–º–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å)

    // ===== –†–ï–î–ê–ö–¢–û–† =====
    const editor = SUNEDITOR.create('editor', {
      lang: SUNEDITOR_LANG['ru'],
      height: '70vh',
      buttonList: [
        ['undo','redo','formatBlock','bold','italic','underline','removeFormat'],
        ['fontColor','hiliteColor','align','list','link','image']
      ]
    });

    // Project ID ‚Üí –∏ –≤ Peecho reference
    const key = 'book_project_id';
    let projectId = localStorage.getItem(key);
    if (!projectId) {
      projectId = 'PROJECT_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem(key, projectId);
    }
    document.getElementById('pid').textContent = projectId;
    document.getElementById('peechoBtn').setAttribute('data-reference', projectId);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –≤ KV
    document.getElementById('saveDraft').onclick = async () => {
      const html = editor.getContents();
      const res = await fetch('/api/draft', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ merchantReference: projectId, html })
      });
      alert(res.ok ? '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    };

    // ===== –ú–û–î–ê–õ–ö–ê –î–û–ù–ê–¢–ê =====
    const modal = document.getElementById('donateModal');
    const btnOpen = document.getElementById('openDonate');
    const btnClose = document.getElementById('donateClose');
    const link1 = document.getElementById('donateLink1');
    const link2 = document.getElementById('donateLink2');
    const paypalBox = document.getElementById('paypalBox');
    const paypalContainer = document.getElementById('paypal-button-container');

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫–∏, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã
    if (DONATE_PAYPAL_ME) { link1.href = DONATE_PAYPAL_ME; link1.classList.remove('hidden'); }
    if (DONATE_KOFI)      { link2.href = DONATE_KOFI;     link2.classList.remove('hidden'); }

    let paypalMounted = false;
    function mountPayPalButtons() {
      if (paypalMounted || !PAYPAL_CLIENT_ID) return;
      paypalMounted = true;
      paypalBox.classList.remove('hidden');

      const sdk = document.createElement('script');
      sdk.src = "https://www.paypal.com/sdk/js"
        + "?client-id=" + encodeURIComponent(PAYPAL_CLIENT_ID)
        + "&currency=EUR"
        + "&intent=capture"
        + "&enable-funding=card"
        + "&components=buttons"
        + "&commit=true";
      sdk.onload = () => {
        paypalContainer.innerHTML = "";
        const renderBtn = (fundingSource, style) => {
          const btn = paypal.Buttons({
            fundingSource,
            style: Object.assign({ layout:'horizontal', label:'donate', tagline:false }, style),
            createOrder: (data, actions) => actions.order.create({
              purchase_units: [{ amount: { value: DONATE_AMOUNT_EUR, currency_code: 'EUR' } }]
            }),
            onApprove: (data, actions) => actions.order.capture().then(() => {
              btnClose.textContent = '–°–ø–∞—Å–∏–±–æ! –ó–∞–∫—Ä—ã—Ç—å';
            })
          });
          if (btn.isEligible()) btn.render('#paypal-button-container');
        };
        // —Å–Ω–∞—á–∞–ª–∞ –∫–∞—Ä—Ç–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞), –∑–∞—Ç–µ–º –æ–±—ã—á–Ω—ã–π PayPal
        renderBtn(paypal.FUNDING.CARD,   { color:'black' });
        renderBtn(paypal.FUNDING.PAYPAL, { color:'gold'  });
      };
      document.body.appendChild(sdk);
    }

    function openDonateModal() {
      modal.style.display = 'flex';
      if (PAYPAL_CLIENT_ID) mountPayPalButtons();
    }
    function closeDonateModal(){ modal.style.display = 'none'; }

    btnOpen.addEventListener('click', e => { e.preventDefault(); openDonateModal(); });
    btnClose.addEventListener('click', () => closeDonateModal());

    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏/–ø–æ–ø—ã—Ç–∫–µ –ø–µ—á–∞—Ç–∏
    document.addEventListener('copy', () => { if (modal.style.display !== 'flex') openDonateModal(); });
    document.addEventListener('keydown', (e) => {
      const isPrint = (e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'p';
      if (isPrint) { e.preventDefault(); openDonateModal(); }
    });
  </script>
</body>
</html>
