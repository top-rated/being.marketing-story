<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–Ω–∏–≥–∞ ‚Äî —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Quill -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
  <style>
    :root{--max:980px}
    body{max-width:var(--max);margin:2rem auto;font-family:system-ui,Arial,sans-serif;padding:0 1rem}
    header{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .muted{opacity:.75;font-size:.9rem}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
    .btn{display:inline-block;padding:.6rem 1rem;border:1px solid #ccc;border-radius:.5rem;text-decoration:none;cursor:pointer;background:#fff}
    .btn-primary{background:#111;color:#fff;border-color:#111}
    .section{margin:1rem 0;padding:1rem;border:1px solid #eee;border-radius:.5rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    #editor{background:#fff}
    .q-toolbar .ql-formats{flex-wrap:wrap}
    .q-wrap{border:1px solid #ddd;border-radius:.5rem;overflow:hidden}
    .q-toolbar{border-bottom:1px solid #ddd}
    .q-editor{height:60vh}
    @media(max-width:480px){.q-editor{height:55vh}}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;max-width:640px;width:calc(100% - 2rem);border-radius:.75rem;padding:1.25rem;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal h2{margin:.25rem 0 .25rem 0}
    .modal p{margin:.5rem 0 1rem 0}
    .paypal-box{border:1px solid #eee;border-radius:.5rem;padding:.75rem}
    /* –∫–Ω–∏–≥–∞ */
    .cover, .backcover, .section-illu {text-align:center}
    .cover-title{font-size:42px;margin-top:120px}
    .cover-sub{font-size:20px;opacity:.8}
    .cover-author{margin-top:12px}
    .illu{max-width:100%;height:auto}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–Ω–∏–≥–∏</h1>
      <div class="muted">Project ID: <span id="pid"></span> ¬∑ –¢–µ—Å—Ç PDF: <a href="/test/pdf" target="_blank">/test/pdf</a></div>
    </div>
    <div class="row">
      <button id="saveBook" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É</button>
      <button id="previewBook" class="btn">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (—Å—Ç—Ä–∞–Ω–∏—Ü—ã)</button>
      <!-- Peecho Async: –±–µ–∑ data-src -->
      <a id="peechoBtn" class="peecho-print-button btn btn-primary"
         href="https://www.peecho.com/"
         title="–ü–µ—á–∞—Ç—å –∫–Ω–∏–≥–∏"
         data-filetype="pdf" data-width="210" data-height="297" data-pages="100"
         data-noprice="true" data-currency="EUR" data-locale="ru_RU"
         data-thumbnail="https://placehold.co/300x400?text=Book"
         data-reference="">–û–ø–ª–∞—Ç–∏—Ç—å –ø–µ—á–∞—Ç—å</a>
      <button id="openDonate" class="btn">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
    </div>
  </header>

  <!-- –ö–û–ù–°–¢–†–£–ö–¢–û–† –ö–ù–ò–ì–ò -->
  <div class="section">
    <h3>–û–±–ª–æ–∂–∫–∞</h3>
    <div class="grid">
      <div>
        <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫<br><input id="coverTitle" class="btn" style="width:100%" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏"></label><br><br>
        <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫<br><input id="coverSub" class="btn" style="width:100%" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"></label><br><br>
        <label>–ê–≤—Ç–æ—Ä<br><input id="coverAuthor" class="btn" style="width:100%" placeholder="–ò–º—è –∞–≤—Ç–æ—Ä–∞"></label>
      </div>
      <div>
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ–±–ª–æ–∂–∫–∏ (A4 –ø–æ—Ä—Ç—Ä–µ—Ç, –æ–ø—Ü.)<br><input id="coverImg" type="file" accept="image/*" class="btn" /></label>
        <div class="muted">–ï—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–∞—è –æ–±–ª–æ–∂–∫–∞.</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–∑–¥–µ–ª–∞ (–æ–ø—Ü.)</h3>
    <input id="sectionImg" type="file" accept="image/*" class="btn" />
  </div>

  <div class="section">
    <h3>–¢–µ–∫—Å—Ç –∫–Ω–∏–≥–∏ (–≤—Å—Ç–∞–≤–ª—è–π —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å)</h3>
    <div class="q-wrap">
      <div id="toolbar" class="q-toolbar">
        <span class="ql-formats">
          <select class="ql-header">
            <option value="1">H1</option>
            <option value="2">H2</option>
            <option selected></option>
          </select>
          <button class="ql-bold"></button>
          <button class="ql-italic"></button>
          <button class="ql-underline"></button>
          <button class="ql-blockquote"></button>
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
          <button class="ql-align" value=""></button>
          <button class="ql-align" value="center"></button>
          <button class="ql-align" value="right"></button>
          <button class="ql-image"></button>
          <button class="ql-clean"></button>
        </span>
      </div>
      <div id="editor" class="q-editor"></div>
    </div>
    <div class="muted">–ü–æ–¥—Å–∫–∞–∑–∫–∞: ¬´–æ—Ç–≤–µ—Ç—ã –æ—Ç —Ä—É–∫–∏¬ª –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –æ–Ω–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–ø–∞–¥—É—Ç –≤ PDF.</div>
  </div>

  <div class="section">
    <h3>–ó–∞–¥–Ω—è—è –æ–±–ª–æ–∂–∫–∞ (–æ–ø—Ü.)</h3>
    <div class="grid">
      <div>
        <label>–¢–µ–∫—Å—Ç –Ω–∞ –∑–∞–¥–Ω–µ–π –æ–±–ª–æ–∂–∫–µ<br><textarea id="backText" class="btn" style="width:100%;height:120px" placeholder="–ö–æ—Ä–æ—Ç–∫–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è"></textarea></label>
      </div>
      <div>
        <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–Ω–µ–π –æ–±–ª–æ–∂–∫–∏ (–æ–ø—Ü.)<br><input id="backImg" type="file" accept="image/*" class="btn" /></label>
      </div>
    </div>
  </div>

  <!-- Peecho merchant script (–æ—Å—Ç–∞–≤—å –∏–ª–∏ –∑–∞–º–µ–Ω–∏ —Å–≤–æ–∏–º) -->
  <script>
    (function(){
      var s=document.createElement("script"); s.async=true;
      s.src="https://d3aln0nj58oevo.cloudfront.net/button/script/175871453943565676.js";
      document.head.appendChild(s);
    })();
  </script>

  <!-- DONATION MODAL (PayPal-only) -->
  <div id="donateModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>–ü–æ–¥–¥–µ—Ä–∂–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç üôè</h2>
      <p>–ú–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã–π –¥–æ–Ω–∞—Ç. –°–ø–∞—Å–∏–±–æ!</p>
      <div class="paypal-box">
        <div id="paypal-button-container"></div>
      </div>
      <div class="row" style="margin-top:.75rem">
        <button id="donateClose" class="btn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>

  <script>
    /************ –ù–ê–°–¢–†–û–ô–ö–ò ************/
    const PAYPAL_CLIENT_ID = "";   // üëà –í–°–¢–ê–í–¨ –∂–∏–≤–æ–π client-id
    const DONATE_AMOUNT_EUR = "2.00";

    /************ –ò–ù–ò–¢ ************/
    // Quill
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: '#toolbar' }
    });

    // Project ID –∏ Peecho reference
    const key = 'book_project_id';
    let projectId = localStorage.getItem(key);
    if (!projectId) { projectId = 'PROJECT_' + Math.random().toString(36).slice(2,10); localStorage.setItem(key, projectId); }
    document.getElementById('pid').textContent = projectId;
    document.getElementById('peechoBtn').setAttribute('data-reference', projectId);

    // helpers: file -> dataURL
    function toDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

    let coverDataURL="", sectionDataURL="", backDataURL="";
    document.getElementById('coverImg').addEventListener('change', async e=>{
      const f=e.target.files[0]; coverDataURL = f ? await toDataURL(f) : "";
    });
    document.getElementById('sectionImg').addEventListener('change', async e=>{
      const f=e.target.files[0]; sectionDataURL = f ? await toDataURL(f) : "";
    });
    document.getElementById('backImg').addEventListener('change', async e=>{
      const f=e.target.files[0]; backDataURL = f ? await toDataURL(f) : "";
    });

    // –°–±–æ—Ä–∫–∞ –ü–û–õ–ù–û–ì–û HTML –∫–Ω–∏–≥–∏ (–æ–±–ª–æ–∂–∫–∞ ‚Üí —Ä–∞–∑–¥–µ–ª ‚Üí –∫–æ–Ω—Ç–µ–Ω—Ç ‚Üí –∑–∞–¥–Ω—è—è)
    function buildBookHTML(){
      const title = (document.getElementById('coverTitle').value||"").trim();
      const sub   = (document.getElementById('coverSub').value||"").trim();
      const auth  = (document.getElementById('coverAuthor').value||"").trim();
      const backT = (document.getElementById('backText').value||"").trim();
      const contentHTML = quill.root.innerHTML;

      return `
<!doctype html>
<html lang="ru"><head><meta charset="utf-8">
<style>
  @page { size: 210mm 297mm; margin: 15mm; }
  body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; }
  h1,h2,h3{ page-break-after: avoid; }
  img{ max-width:100%; height:auto; page-break-inside: avoid; }
  .page-break{ page-break-before: always; }
  .cover, .backcover, .section-illu { display:flex; flex-direction:column; align-items:center; justify-content:center; min-height: 257mm; text-align:center; }
  .cover .bg{ position:absolute; inset:0; }
  .cover .content{ position:relative; z-index:2; }
  .cover-title{ font-size:42px; margin:0 0 12px 0; }
  .cover-sub{ font-size:20px; opacity:.8; margin:0 0 6px 0; }
  .cover-author{ margin:0; font-size:16px; }
  .illu{ max-width:100%; }
  .content{ }
</style>
</head>
<body>
  <section class="cover" style="position:relative; overflow:hidden;">
    ${coverDataURL ? `<img class="bg" src="${coverDataURL}" alt="cover">` : ``}
    <div class="content">
      ${title?`<h1 class="cover-title">${title}</h1>`:''}
      ${sub?`<div class="cover-sub">${sub}</div>`:''}
      ${auth?`<p class="cover-author">${auth}</p>`:''}
    </div>
  </section>

  ${sectionDataURL ? `
  <section class="section-illu page-break">
    <img class="illu" src="${sectionDataURL}" alt="section">
  </section>`:''}

  <section class="content ${sectionDataURL ? '' : 'page-break'}">
    ${contentHTML}
  </section>

  <section class="backcover page-break">
    ${backDataURL ? `<img class="illu" src="${backDataURL}" alt="back">` : ``}
    ${backT ? `<div style="max-width:70ch;margin-top:1rem;white-space:pre-wrap">${backT}</div>` : ``}
  </section>
</body></html>`;
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É (–≤ KV –ø–∏—à–µ–º —É–∂–µ –°–§–û–†–ú–ò–†–û–í–ê–ù–ù–´–ô HTML)
    document.getElementById('saveBook').onclick = async () => {
      const bookHTML = buildBookHTML();
      const res = await fetch('/api/draft', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ merchantReference: projectId, html: bookHTML })
      });
      alert(res.ok ? '–ö–Ω–∏–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    };

    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (Paged.js) ‚Äî –æ—Ç–∫—Ä–æ–µ–º –≤–æ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–º –æ–∫–Ω–µ
    document.getElementById('previewBook').onclick = async () => {
      const bookHTML = buildBookHTML();
      const win = window.open('', '_blank');
      const withPaged = `
${bookHTML.replace('</body>',
  `<script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"><\/script></body>`)}
`;
      win.document.write(withPaged);
      win.document.close();
    };

    // DONATION MODAL (PayPal only)
    const modal = document.getElementById('donateModal');
    const btnOpen = document.getElementById('openDonate');
    const btnClose = document.getElementById('donateClose');

    function openDonateModal(){
      modal.style.display='flex';
      if (PAYPAL_CLIENT_ID && !window.__ppMounted){
        window.__ppMounted = true;
        const sdk = document.createElement('script');
        sdk.src = "https://www.paypal.com/sdk/js"
          + "?client-id=" + encodeURIComponent(PAYPAL_CLIENT_ID)
          + "&currency=EUR&intent=capture&enable-funding=card&components=buttons&commit=true";
        sdk.onload = () => {
          const renderBtn = (fundingSource, style) => {
            const btn = paypal.Buttons({
              fundingSource,
              style: Object.assign({ layout:'horizontal', label:'donate', tagline:false }, style),
              createOrder: (data, actions) => actions.order.create({
                application_context:{ shipping_preference:'NO_SHIPPING', user_action:'PAY_NOW' },
                purchase_units:[{ amount:{ value: DONATE_AMOUNT_EUR, currency_code:'EUR' } }]
              }),
              onApprove: (data, actions) => actions.order.capture().then(()=>{ btnClose.textContent='–°–ø–∞—Å–∏–±–æ! –ó–∞–∫—Ä—ã—Ç—å'; })
            });
            if (btn.isEligible()) btn.render('#paypal-button-container');
          };
          renderBtn(paypal.FUNDING.CARD, { color:'black' });
          renderBtn(paypal.FUNDING.PAYPAL, { color:'gold' });
        };
        document.body.appendChild(sdk);
      }
    }
    function closeDonateModal(){ modal.style.display='none'; }
    btnOpen.onclick = () => openDonateModal();
    btnClose.onclick = () => closeDonateModal();

    // –ú—è–≥–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–Ω–∞—Ç–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏/–ø–µ—á–∞—Ç–∏
    document.addEventListener('copy', ()=>{ if (modal.style.display!=='flex') openDonateModal(); });
    document.addEventListener('keydown', (e)=>{
      const isPrint=(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='p';
      if(isPrint){ e.preventDefault(); openDonateModal(); }
    });
  </script>
</body>
</html>
